<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>Shiftly – איפוס סיסמה</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
    <style>
      :root {
        --bg1: #1a1a1a;
        --bg2: #0d0d0d;
        --accent: #e91e63;
        --accent-soft: rgba(233, 30, 99, 0.15);
        --text: #ffffff;
        --text-muted: #b0b0b0;
        --error-bg: rgba(255, 107, 107, 0.1);
        --error-text: #ff6b6b;
      }
      * {
        box-sizing: border-box;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, var(--bg1), var(--bg2));
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        width: 100%;
        max-width: 420px;
        padding: 32px 28px 28px;
        border-radius: 18px;
        background: linear-gradient(145deg, #111, #181818);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }
      .title {
        font-size: 28px;
        font-weight: 800;
        color: var(--accent);
        margin: 0 0 8px;
        text-align: center;
      }
      .subtitle {
        font-size: 15px;
        color: var(--text-muted);
        text-align: center;
        margin: 0 0 24px;
      }
      .field-label {
        font-size: 14px;
        margin-bottom: 6px;
      }
      .input {
        width: 100%;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.04);
        color: var(--text);
        font-size: 15px;
      }
      .input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(233, 30, 99, 0.5);
      }
      .button {
        width: 100%;
        margin-top: 16px;
        padding: 12px;
        border: none;
        border-radius: 999px;
        background: var(--accent);
        color: #fff;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.08s ease, box-shadow 0.08s ease,
          background 0.15s ease;
        box-shadow: 0 10px 25px rgba(233, 30, 99, 0.55);
      }
      .button:hover {
        background: #f06292;
        transform: translateY(-1px);
        box-shadow: 0 14px 30px rgba(233, 30, 99, 0.7);
      }
      .button:disabled {
        opacity: 0.6;
        cursor: default;
        box-shadow: none;
        transform: none;
      }
      .error {
        margin-top: 8px;
        padding: 10px 12px;
        border-radius: 10px;
        background: var(--error-bg);
        color: var(--error-text);
        font-size: 13px;
        text-align: center;
      }
      .success {
        margin-top: 8px;
        padding: 10px 12px;
        border-radius: 10px;
        background: var(--accent-soft);
        color: #ffb6d0;
        font-size: 13px;
        text-align: center;
      }
      .footer {
        margin-top: 20px;
        font-size: 13px;
        color: var(--text-muted);
        text-align: center;
      }
      .spinner {
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-top-color: #fff;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 0.6s linear infinite;
        display: inline-block;
        vertical-align: middle;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1 class="title">איפוס סיסמה</h1>
      <p class="subtitle">
        הזן סיסמה חדשה. לאחר האיפוס תוכל להתחבר לאפליקציית Shiftly.
      </p>

      <div id="message"></div>

      <div>
        <div class="field-label">סיסמה חדשה</div>
        <input
          id="password"
          class="input"
          type="password"
          autocomplete="new-password"
          placeholder="••••••••"
        />
      </div>

      <div style="margin-top: 14px">
        <div class="field-label">אישור סיסמה</div>
        <input
          id="passwordConfirm"
          class="input"
          type="password"
          autocomplete="new-password"
          placeholder="••••••••"
        />
      </div>

      <button id="submitBtn" class="button">עדכן סיסמה</button>

      <div class="footer">אם האיפוס לא מצליח, נסה לבקש קישור חדש מהאפליקציה.</div>
    </div>

    <script>
      // TODO: fill these with your real values
      const SUPABASE_URL = "https://YOUR-PROJECT-REF.supabase.co";
      const SUPABASE_ANON_KEY = "YOUR_ANON_PUBLIC_KEY";

      const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: false,
        },
      });

      const msgEl = document.getElementById("message");
      const btn = document.getElementById("submitBtn");
      const passEl = document.getElementById("password");
      const pass2El = document.getElementById("passwordConfirm");

      function setMessage(type, text) {
        msgEl.innerHTML = "";
        if (!text) return;
        const div = document.createElement("div");
        div.className = type === "error" ? "error" : "success";
        div.textContent = text;
        msgEl.appendChild(div);
      }

      function parseParams() {
        const all = new URLSearchParams();
        const { hash, search } = window.location;

        if (hash && hash.length > 1) {
          const h = new URLSearchParams(hash.substring(1));
          h.forEach((v, k) => all.append(k, v));
        }
        if (search && search.length > 1) {
          const q = new URLSearchParams(search.substring(1));
          q.forEach((v, k) => all.append(k, v));
        }
        return all;
      }

      async function initSessionFromUrl() {
        const params = parseParams();
        const code = params.get("code");
        const accessToken = params.get("access_token");
        const refreshToken = params.get("refresh_token");

        try {
          if (code) {
            const { error } = await client.auth.exchangeCodeForSession({ code });
            if (error) throw error;
            return true;
          }

          if (accessToken && refreshToken) {
            const { error } = await client.auth.setSession({
              access_token: accessToken,
              refresh_token: refreshToken,
            });
            if (error) throw error;
            return true;
          }

          setMessage(
            "error",
            "קישור האיפוס אינו תקף או שחסרים בו פרטים. נסה לבקש קישור חדש מהאפליקציה."
          );
          return false;
        } catch (e) {
          console.error("Init session from URL failed:", e);
          setMessage(
            "error",
            "קישור האיפוס אינו תקף או שפג תוקפו. נסה לבקש קישור חדש מהאפליקציה."
          );
          return false;
        }
      }

      async function handleSubmit() {
        setMessage("", "");
        const p1 = passEl.value.trim();
        const p2 = pass2El.value.trim();

        if (!p1 || !p2) {
          setMessage("error", "נא למלא את שתי הסיסמאות");
          return;
        }
        if (p1 !== p2) {
          setMessage("error", "הסיסמאות אינן תואמות");
          return;
        }
        if (p1.length < 6) {
          setMessage("error", "הסיסמה חייבת להכיל לפחות 6 תווים");
          return;
        }

        btn.disabled = true;
        const oldText = btn.textContent;
        btn.innerHTML = '<span class="spinner"></span> מעדכן...';

        try {
          const { error } = await client.auth.updateUser({ password: p1 });
          if (error) {
            console.error("updateUser error:", error);
            setMessage(
              "error",
              "קישור האיפוס אינו תקף או שפג תוקפו. נסה לבקש קישור חדש מהאפליקציה."
            );
            return;
          }

          setMessage("success", "הסיסמה עודכנה בהצלחה! כעת ניתן להתחבר לאפליקציה.");
          passEl.value = "";
          pass2El.value = "";
        } finally {
          btn.disabled = false;
          btn.textContent = oldText;
        }
      }

      (async () => {
        const ok = await initSessionFromUrl();
        if (!ok) {
          // disable button if no valid session
          btn.disabled = true;
        }
      })();

      btn.addEventListener("click", handleSubmit);
    </script>
  </body>
</html>
